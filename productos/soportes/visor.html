<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Personalizador 3D - Kreoma3D</title>

<style>
:root{
  --panelH:35vh; /* Antes estaba en 45vh. Al bajarlo, el panel se hace m√°s bajo y el 3D gana m√°s espacio */
  --topbarH:50px;
  --fontBig:clamp(16px,4.8vw,22px);
  --fontSemi:clamp(14px,4vw,19px);
  --colorSize:clamp(26px,6vw,36px); /* Antes arrancaba en 34px. Ahora los c√≠rculos son m√°s peque√±os */
  --radius:clamp(14px,3vw,24px);
  --border:#dedede;
}

/* GENERAL */
*{margin:0;padding:0;box-sizing:border-box;}
body{
  width:100vw; height:100vh; overflow:hidden;
  background:#e6e6e6; font-family:system-ui,-apple-system,sans-serif; color:#111;
}

/* TOPBAR */
.topbar{
  position:fixed; top:0; left:0; right:0; height:var(--topbarH); z-index:30;
  display:flex; align-items:center; justify-content:space-between; padding:0 18px;
  background:linear-gradient(135deg, rgba(255,153,51,0.96), rgba(255,102,0,0.98));
  backdrop-filter:blur(14px); box-shadow:0 4px 14px rgba(0,0,0,.25);
}
.topbar img{ height:160px; cursor:pointer; }
.topbar h1{
  font-size:clamp(14px,4vw,20px); font-weight:600; text-align:center;
  flex:1; margin:0 12px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; color:#fff;
}
.topbar nav a{ color:#fff; text-decoration:none; margin-left:16px; font-weight:500; opacity:0.9; }

/* VISOR */
#visor{ position:fixed; top:var(--topbarH); left:0; right:0; bottom:var(--panelH); height:auto; overflow:hidden; }
#visor-bg{ position:absolute; inset:0; background:url("logo_kreoma.png") center center no-repeat; background-size:70vmin; opacity:.10; pointer-events:none; z-index:1; }
#canvas-container{ position:absolute; inset:0; z-index:5; }

/* PANEL */
#panel{
  position:fixed; bottom:0; left:0; right:0; height:var(--panelH); z-index:20;
  background:#ffffffee; backdrop-filter:blur(9px); border-top:1px solid var(--border);
  padding:clamp(12px,3vw,24px); display:flex; flex-direction:column; gap:12px;
  overflow-y:auto;
}


/* TABS */
#tabs{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
.tab{
  padding:10px 14px; border-radius:99px; background:#f5f5f5; border:1px solid #ccc;
  font-size:13px; font-weight:700; text-align:center; cursor:pointer; transition:all .2s;
  text-transform: uppercase;
}
.tab.activo{ background:#111; color:#fff; border-color:#111; transform:translateY(-1px); }

/* COLORES */
#bloque-colores h3{ font-size:var(--fontSemi); font-weight:700; margin-bottom:5px; }
#paleta{ display:flex; flex-wrap:wrap; gap:8px; }
.color{
  width:var(--colorSize); height:var(--colorSize); border-radius:50%; border:3px solid #fff;
  box-shadow:0 0 6px rgba(0,0,0,.3); cursor:pointer; transition:transform .15s;
}
.color.sel{ outline:3px solid #000; transform: scale(1.1); }

/* LOGO BLOCK */
#logo-block{ display:none; flex-direction:column; gap:8px; background:rgba(0,0,0,0.03); padding:10px; border-radius:var(--radius); }
.logo-type-switch{ display:flex; gap:15px; margin-bottom:5px; }
.logo-type-switch label{ display:flex; align-items:center; gap:6px; font-size:var(--fontSemi); cursor:pointer; font-weight:600; }
select, input[type="text"]{ width:100%; padding:12px; border-radius:12px; border:1px solid #ccc; font-size:16px; text-transform: uppercase; }

/* BOT√ìN WHATSAPP GRANDE */
#enviarWhatsApp{
  margin-top:4px; width:100%; padding:11px; background:#25D366; color:#fff; border:none;
  border-radius:var(--radius); font-size:18px; font-weight:900; cursor:pointer;
  box-shadow:0 6px 16px rgba(0,0,0,.25); transition:all .2s;
  text-transform: uppercase;
}
#enviarWhatsApp:active { transform: scale(0.95); }

.hidden{ display:none; }
canvas{ filter:drop-shadow(0 20px 35px rgba(0,0,0,.4)); }

@media(min-width:900px){ :root{ --panelH:35vh; } #panel{ padding:20px 40px; } }
</style>
</head>

<body>

<div class="topbar">
  <a href="../../index.html"><img src="logo_kreoma.png" alt="Kreoma3D"></a>
  <h1>Personalizador ‚Ä¢ Soporte 3 en 1</h1>
  <nav><a href="../index.html">Inicio</a></nav>
</div>

<div id="visor">
  <div id="visor-bg"></div>
  <div id="canvas-container"></div>
</div>

<div id="panel">
  <div id="tabs">
    <div class="tab activo" data-grupo="base"> Base</div>
    <div class="tab" data-grupo="superior"> Superior</div>
    <div class="tab" data-grupo="insert"> Insertos</div>
    <div class="tab" data-grupo="logo">‚úçÔ∏è Nombre/Logo</div>
  </div>

  <div id="bloque-colores">
    <div id="paleta"></div>
  </div>

  <div id="logo-block">
    <div class="logo-type-switch">
      <label><input type="radio" name="tipoLogo" value="catalogo" checked> Logo</label>
      <label><input type="radio" name="tipoLogo" value="texto"> Nombre</label>
    </div>
    <div id="cont-select-logo"><select id="logo-select"></select></div>
    <div id="cont-input-text" class="hidden">
      <input type="text" id="custom-text" placeholder="ESCRIBE AQU√ç TU NOMBRE" maxlength="12">
    </div>
  </div>

  <button id="enviarWhatsApp" type="button">‚úÖ PEDIR POR WHATSAPP</button>
</div>

<script type="importmap">
  { "imports": { "three": "https://unpkg.com/three@0.158.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/" } }
</script>

<script type="module">
import * as THREE from 'three';
import { STLLoader } from 'three/addons/loaders/STLLoader.js';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { FontLoader } from 'three/addons/loaders/FontLoader.js';
import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';

/* CONFIGURACI√ìN ESCENA */
const canvasContainer = document.getElementById("canvas-container");
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, canvasContainer.clientWidth/canvasContainer.clientHeight, 0.1, 10000);

camera.position.set(-130,0,130);

const renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
canvasContainer.appendChild(renderer.domElement);

const hemi = new THREE.HemisphereLight(0xffffff,0x777777,1.3); scene.add(hemi);
const dir = new THREE.DirectionalLight(0xffffff,0.85); dir.position.set(1,1,1); scene.add(dir);
scene.add(new THREE.AmbientLight(0xffffff,0.35));

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true; controls.dampingFactor = 0.06;

const world = new THREE.Group();
world.position.y = -140; world.position.x = 175;
scene.add(world);

const STL_POS = { x: 11, y: -15, z: -5 };
const STL_ROT = { x: Math.PI, y: 0, z: Math.PI };
const TXT_POS = { x: -156, y: 103, z: -17 };
const TXT_ROT = { x: 1.5, y: 5.3, z: 3.1 };

const loader = new STLLoader();
const fontLoader = new FontLoader();
let fuenteCargada = null;
const FONT_URL = 'https://unpkg.com/three@0.158.0/examples/fonts/helvetiker_bold.typeface.json';

const piezas = {
  base: {file:"Helm-Wandhalter.stl", mesh:null},
  superior: {file:"Helm-Halter.stl", mesh:null},
  inserts: ["Insert1.stl","Insert2.stl","Insert3.stl","Insert4.stl","Insert5.stl"],
  insertMeshes: [],
  logo: { mesh:null }
};

let grupoActivo = "base";
let modoLogo = "catalogo";
const seleccion = {
  base: {c:"#000000"}, superior: {c:"#ff8000"}, insert: {c:"#ff8000"}, logo: {c:"#ff8000"}
};

/* CARGAR MODELOS */
function cargarEstructura(){
  loader.load(piezas.base.file, g=>{
    const m=new THREE.Mesh(g,new THREE.MeshStandardMaterial({color:seleccion.base.c}));
    m.rotation.set(Math.PI,0,Math.PI); world.add(m); piezas.base.mesh=m;
  });
  loader.load(piezas.superior.file,g=>{
    const m=new THREE.Mesh(g,new THREE.MeshStandardMaterial({color:seleccion.superior.c}));
    m.rotation.set(Math.PI,0,Math.PI); world.add(m); piezas.superior.mesh=m;
  });
  piezas.inserts.forEach(f=>{
    loader.load(f,g=>{
      const m=new THREE.Mesh(g,new THREE.MeshStandardMaterial({color:seleccion.insert.c}));
      m.rotation.set(Math.PI,0,Math.PI); world.add(m); piezas.insertMeshes.push(m);
    });
  });
  fontLoader.load(FONT_URL, (font) => { fuenteCargada = font; });
  cargarLogoSTL("logoYamaha.stl");
}

function limpiarLogoAnterior(){
  if(piezas.logo.mesh){
    world.remove(piezas.logo.mesh);
    piezas.logo.mesh = null;
  }
}

function cargarLogoSTL(archivo){
  limpiarLogoAnterior();
  if(!archivo) return;
  loader.load(archivo, g=>{
    const m=new THREE.Mesh(g,new THREE.MeshStandardMaterial({color:seleccion.logo.c}));
    m.position.set(STL_POS.x, STL_POS.y, STL_POS.z);
    m.rotation.set(STL_ROT.x, STL_ROT.y, STL_ROT.z);
    world.add(m); piezas.logo.mesh=m;
  });
}

function generarTexto3D(textoString){
  limpiarLogoAnterior();
  if(!fuenteCargada || !textoString) return;
  const textoMayus = textoString.toUpperCase();
  const mat = new THREE.MeshStandardMaterial({color: seleccion.logo.c});
  const grupoTexto = new THREE.Group();
  let offsetActual = 0;
  
  textoMayus.split('').forEach(letra => {
    if(letra === " "){ offsetActual += 10; return; }
    const geo = new TextGeometry(letra, { font: fuenteCargada, size: 18, height: 2, curveSegments: 4, bevelEnabled: true, bevelThickness: 0.5, bevelSize: 0.3 });
    geo.computeBoundingBox();
    const ancho = geo.boundingBox.max.x - geo.boundingBox.min.x;
    geo.translate(offsetActual, 0, 0);
    grupoTexto.add(new THREE.Mesh(geo, mat));
    offsetActual += ancho + 2;
  });
  
  const centroX = -offsetActual / 2;
  grupoTexto.children.forEach(c => c.geometry.translate(centroX, -9, 0));
  grupoTexto.position.set(TXT_POS.x, TXT_POS.y, TXT_POS.z);
  grupoTexto.rotation.set(TXT_ROT.x, TXT_ROT.y, TXT_ROT.z);
  world.add(grupoTexto); piezas.logo.mesh = grupoTexto;
}

/* INTERFAZ */
const colores=[
  {n:"Amarillo",c:"#fff700"}, {n:"Blanco",c:"#ffffff"},{n:"Verde Lim√≥n",c:"#68fd3f"},
  {n:"Negro",c:"#000000"}, {n:"Azul",c:"#0000ff"}, {n:"Oro",c:"#ffff94"},
  {n:"Verde",c:"#2e7d32"}, {n:"Rosado",c:"#ff8783"}, {n:"Morado",c:"#7f00b2"}, {n:"Azul Cielo",c:"#80caff"},
  {n:"Caf√©",c:"#8b4513"}, {n:"Rojo",c:"#ff0000"}, {n:"Gris",c:"#8d8d8d"}, {n:"Naranja",c:"#ff8000"},
  {n:"Menta",c:"#9ce0db"}, {n:"Madera",c:"#ffe8d0"}
];

function crearPaleta(){
  const paleta = document.getElementById("paleta");
  colores.forEach(col=>{
    const el=document.createElement("div");
    el.className="color"; el.dataset.hex=col.c; el.style.background=col.c;
    el.addEventListener("click",()=>{ 
      aplicarColor(grupoActivo, col.c); 
      resaltarSeleccion();
    });
    paleta.appendChild(el);
  });
  resaltarSeleccion();
}
  

function aplicarColor(grupo, hex){
  seleccion[grupo].c = hex;
  
  const esOro = (hex.toLowerCase() === "#ffff94");
  const valorMetal = esOro ? 0.4 : 0.0;
  const valorRugosidad = esOro ? 0.1 : 0.8;

  const actualizarMaterial = (mesh) => {
    if(!mesh) return;
    if(mesh.isGroup) {
      mesh.children.forEach(c => {
        c.material.color.set(hex);
        c.material.metalness = valorMetal;
        c.material.roughness = valorRugosidad;
      });
    } else {
      mesh.material.color.set(hex);
      mesh.material.metalness = valorMetal;
      mesh.material.roughness = valorRugosidad;
    }
  };

  if(grupo==="base") actualizarMaterial(piezas.base.mesh);
  if(grupo==="superior") actualizarMaterial(piezas.superior.mesh);
  if(grupo==="insert") piezas.insertMeshes.forEach(m => actualizarMaterial(m));
  if(grupo==="logo") actualizarMaterial(piezas.logo.mesh);
}

function resaltarSeleccion(){
  const hexSel=seleccion[grupoActivo].c;
  document.querySelectorAll(".color").forEach(el=>{
    if(el.dataset.hex===hexSel) el.classList.add("sel"); else el.classList.remove("sel");
  });
}

const tabs = document.querySelectorAll(".tab");
tabs.forEach(tab=>{
  tab.addEventListener("click",()=>{
    tabs.forEach(t=>t.classList.remove("activo"));
    tab.classList.add("activo");
    grupoActivo=tab.dataset.grupo;
    document.getElementById("logo-block").style.display = (grupoActivo==="logo") ? "flex" : "none";
    resaltarSeleccion();
  });
});

/* LISTA LOGOS */
const logos=[{n:"Yamaha",f:"logoYamaha.stl"},{n:"Sin logo",f:""},{n:"Nmax",f:"logoNmax.stl"},{n:"V-Strom",f:"logoVstrom.stl"},{n:"Ktm",f:"logoKtm.stl"},{n:"FOX",f:"logoFox.stl"},{n:"Monster",f:"logoMonster.stl"},{n:"Nike",f:"logoNike.stl"},{n:"Honda",f:"logoHonda.stl"},{n:"Suzuki",f:"logoSuzuki.stl"},{n:"Pulsar",f:"logoPulsar.stl"},{n:"AKT",f:"logoAKT.stl"},{n:"Royal Enfield",f:"logoRoyal.stl"},{n:"Dominar",f:"logoDominar.stl"},{n:"Kawasaki",f:"logoKawasaki.stl"},{n:"Discover",f:"logoDiscover.stl"}];
const logoSelect = document.getElementById('logo-select');
logos.forEach(l=>{
  const opt=document.createElement("option"); opt.value=l.f; opt.textContent=l.n;
  logoSelect.appendChild(opt);
});
logoSelect.addEventListener("change",()=>{ cargarLogoSTL(logoSelect.value); });

const customInput = document.getElementById('custom-text');
customInput.addEventListener('input', (e)=>{ generarTexto3D(e.target.value); });

document.querySelectorAll('input[name="tipoLogo"]').forEach(r => {
  r.addEventListener('change', (e) => {
    modoLogo = e.target.value;
    document.getElementById('cont-select-logo').classList.toggle('hidden', modoLogo!=='catalogo');
    document.getElementById('cont-input-text').classList.toggle('hidden', modoLogo!=='texto');
    if(modoLogo==='catalogo') cargarLogoSTL(logoSelect.value); else generarTexto3D(customInput.value);
  });
});

/* WHATSAPP + CAPTURA LEAD EN ERP (RESTAURADO) */
function nombreColor(hex) {
  const c = colores.find(x => x.c.toLowerCase() === hex.toLowerCase());
  return c ? c.n : "Personalizado";
}

function enviarLeadNoBloqueante(payload) {
  const API_URL = "https://www.fpc.com.co/Kreoma/api/lead_create.php";
  const API_KEY = "f7N#z2K9v$Lp8Qx@m5W&1jR*tS6uB4cY9gH3eD!aV0n";

  try {
    if (navigator.sendBeacon) {
      const urlConKey = API_URL + "?k=" + encodeURIComponent(API_KEY);
      const blob = new Blob([JSON.stringify(payload)], { type: "text/plain;charset=UTF-8" });
      const ok = navigator.sendBeacon(urlConKey, blob);
      if (ok) return;
    }
  } catch (e) {}

  try {
    fetch(API_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-KREOMA-KEY": API_KEY
      },
      body: JSON.stringify(payload),
      keepalive: true,
      mode: "cors"
    }).catch(()=>{});
  } catch (e) {}
}

document.getElementById("enviarWhatsApp").addEventListener("click", () => {
  const baseC = nombreColor(seleccion.base.c);
  const supC  = nombreColor(seleccion.superior.c);
  const insC  = nombreColor(seleccion.insert.c);
  const logC  = nombreColor(seleccion.logo.c);

  let infoLogo = "";
  let logoModo = "";
  let logoValor = "";

  if (modoLogo === "catalogo") {
    const nombreL = logoSelect.selectedOptions[0]?.textContent || "Ninguno";
    infoLogo = `Logo cat√°logo: ${nombreL}`;
    logoModo = "catalogo";
    logoValor = nombreL;
  } else {
    const texto = (customInput.value || "").trim().toUpperCase() || "Sin texto";
    infoLogo = `Nombre personalizado: "${texto}"`;
    logoModo = "texto";
    logoValor = texto;
  }

  const msg = `Hola Kreoma3D! üëã\nQuiero mi soporte personalizado:\n‚Ä¢ Base: ${baseC}\n‚Ä¢ Superior: ${supC}\n‚Ä¢ Insertos: ${insC}\n‚Ä¢ ${infoLogo} (Color: ${logC})`;

  const waUrl = `https://wa.me/573332395481?text=${encodeURIComponent(msg)}`;
  const waWin = window.open(waUrl, "_blank");

  if (!waWin) { window.location.href = waUrl; }

  const payload = {
    origen: "visor_soporte_v1",
    producto_key: "SOPORTE_3EN1",
    base_color: baseC,
    superior_color: supC,
    insert_color: insC,
    logo_color: logC,
    logo_modo: logoModo,
    logo_valor: logoValor,
    mensaje_whatsapp: msg
  };

  setTimeout(() => enviarLeadNoBloqueante(payload), 0);
});

function animate(){ requestAnimationFrame(animate); controls.update(); renderer.render(scene,camera); }
animate();
window.addEventListener("resize",()=>{
  renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
  camera.aspect=canvasContainer.clientWidth/canvasContainer.clientHeight;
  camera.updateProjectionMatrix();
});
cargarEstructura(); crearPaleta();
</script>
</body>
</html>







