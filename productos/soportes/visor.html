<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  
  <title>Personalizador 3D - Kreoma3D</title>

<style>
:root{
  --panelH:35vh;            
  --topbarH:62px;
  --fontBig:clamp(16px,4.8vw,22px);
  --fontSemi:clamp(14px,4vw,19px);
  --colorSize:clamp(34px,8vw,44px);
  --radius:clamp(14px,3vw,24px);
  --border:#dedede;
}

/* GENERAL */
*{margin:0;padding:0;box-sizing:border-box;}
body{
  width:100vw; height:100vh; overflow:hidden;
  background:#e6e6e6; font-family:system-ui,-apple-system,sans-serif; color:#111;
}

/* TOPBAR */
.topbar{
  position:fixed; top:0; left:0; right:0; height:var(--topbarH); z-index:30;
  display:flex; align-items:center; justify-content:space-between; padding:0 18px;
  background:linear-gradient(135deg, rgba(255,153,51,0.96), rgba(255,102,0,0.98));
  backdrop-filter:blur(14px); box-shadow:0 4px 14px rgba(0,0,0,.25);
}
.topbar img{ height:160px; cursor:pointer; }
.topbar h1{
  font-size:clamp(14px,4vw,20px); font-weight:600; text-align:center;
  flex:1; margin:0 12px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; color:#fff;
}
.topbar nav a{ color:#fff; text-decoration:none; margin-left:16px; font-weight:500; opacity:0.9; }

/* VISOR */
#visor{ position:fixed; top:var(--topbarH); left:0; right:0; bottom:var(--panelH); height:auto; overflow:hidden; }
#visor-bg{ position:absolute; inset:0; background:url("logo_kreoma.png") center center no-repeat; background-size:70vmin; opacity:.10; pointer-events:none; z-index:1; }
#canvas-container{ position:absolute; inset:0; z-index:5; }

/* PANEL */
#panel{
  position:fixed; bottom:0; left:0; right:0; height:var(--panelH); z-index:20;
  background:#ffffffee; backdrop-filter:blur(9px); border-top:1px solid var(--border);
  padding:clamp(12px,3vw,24px); display:flex; flex-direction:column; gap:clamp(10px,3vw,14px);
  overflow-y:auto;
}

/* TABS */
#tabs{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
.tab{
  padding:8px 16px; border-radius:99px; background:#f5f5f5; border:1px solid #ccc;
  font-size:var(--fontSemi); font-weight:600; text-align:center; cursor:pointer; transition:all .2s;
}
.tab:hover{ transform:translateY(-1px); box-shadow:0 4px 10px rgba(0,0,0,.15); }
.tab.activo{ background:#111; color:#fff; border-color:#111; transform:translateY(-1px); }

/* COLORES */
#bloque-colores h3{ font-size:var(--fontSemi); font-weight:700; margin-bottom:5px; }
#paleta{ display:flex; flex-wrap:wrap; gap:8px; }
.color{
  width:var(--colorSize); height:var(--colorSize); border-radius:50%; border:3px solid #fff;
  box-shadow:0 0 6px rgba(0,0,0,.3); cursor:pointer; transition:transform .15s;
}
.color:hover{ transform:scale(1.1); }
.color.sel{ outline:3px solid #000; }

/* LOGO BLOCK */
#logo-block{ display:none; flex-direction:column; gap:8px; background:rgba(0,0,0,0.03); padding:10px; border-radius:var(--radius); }
.logo-type-switch{ display:flex; gap:15px; margin-bottom:5px; }
.logo-type-switch label{ display:flex; align-items:center; gap:6px; font-size:var(--fontSemi); cursor:pointer; font-weight:600; }
.logo-type-switch input[type="radio"] { accent-color:#ff8000; transform:scale(1.2); }
select, input[type="text"]{ width:100%; padding:10px 14px; border-radius:12px; border:1px solid #ccc; font-size:16px; font-family:inherit; }
input[type="text"]:focus, select:focus{ outline:2px solid #ff8000; border-color:#ff8000; }
.hidden{ display:none; }

/* BOT√ìN */
#enviarWhatsApp{
  margin-top:auto; width:100%; padding:14px; background:#25D366; color:#fff; border:none;
  border-radius:var(--radius); font-size:16px; font-weight:700; cursor:pointer;
  box-shadow:0 6px 16px rgba(0,0,0,.25); transition:transform .15s;
}
#enviarWhatsApp:hover{ background:#1ebe5c; transform:translateY(-1px); }
canvas{ filter:drop-shadow(0 20px 35px rgba(0,0,0,.4)); }

@media(min-width:900px){ :root{ --panelH:30vh; } #panel{ padding:20px 40px; } #tabs{ justify-content:flex-start; } }
</style>
</head>

<body>

<div class="topbar">
  <h1>Personalizador 3D ‚Ä¢ Soporte de casco 3 en 1</h1>
</div>

<div id="visor">
  <div id="visor-bg"></div>
  <div id="canvas-container"></div>
</div>

<div id="panel">
  <div id="tabs">
    <div class="tab activo" data-grupo="base">Base</div>
    <div class="tab" data-grupo="superior">Superior</div>
    <div class="tab" data-grupo="insert">Insertos</div>
    <div class="tab" data-grupo="logo">Logo / Nombre</div>
  </div>

  <div id="bloque-colores">
    <h3>Color</h3>
    <div id="paleta"></div>
  </div>

  <div id="logo-block">
    <div class="logo-type-switch">
      <label><input type="radio" name="tipoLogo" value="catalogo" checked> Logo Cat√°logo</label>
      <label><input type="radio" name="tipoLogo" value="texto"> Escribir Nombre</label>
    </div>
    <div id="cont-select-logo"><select id="logo-select"></select></div>
    <div id="cont-input-text" class="hidden">
      <input type="text" id="custom-text" placeholder="Escribe tu nombre (M√°x 10 letras)" maxlength="12">
    </div>
  </div>

  <button id="enviarWhatsApp">Enviar Personalizaci√≥n a WhatsApp</button>
</div>

<script type="importmap">
  { "imports": { "three": "https://unpkg.com/three@0.158.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/" } }
</script>

<script type="module">
import * as THREE from 'three';
import { STLLoader } from 'three/addons/loaders/STLLoader.js';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { FontLoader } from 'three/addons/loaders/FontLoader.js';
import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';

/* CONFIGURACI√ìN ESCENA */
const canvasContainer = document.getElementById("canvas-container");
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, canvasContainer.clientWidth/canvasContainer.clientHeight, 0.1, 10000);
camera.position.set(-200,0,200);

const renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
canvasContainer.appendChild(renderer.domElement);

const hemi = new THREE.HemisphereLight(0xffffff,0x777777,1.3); scene.add(hemi);
const dir = new THREE.DirectionalLight(0xffffff,0.85); dir.position.set(1,1,1); scene.add(dir);
scene.add(new THREE.AmbientLight(0xffffff,0.35));

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true; controls.dampingFactor = 0.06;

/* GRUPO PRINCIPAL */
const world = new THREE.Group();
world.position.y = -160; world.position.x = 170;
scene.add(world);

/* --- CONFIGURACI√ìN DE POSICIONES --- */

// 1. Posici√≥n para los Logos STL
const STL_POS = { x: 11, y: -15, z: -5 };
const STL_ROT = { x: Math.PI, y: 0, z: Math.PI };

// 2. Posici√≥n CALIBRADA para el Texto 3D
const TXT_POS = { x: -156, y: 103, z: -17 };
const TXT_ROT = { x: 1.5, y: 5.3, z: 3.1 };

/* GESTI√ìN DE MODELOS */
const loader = new STLLoader();
const fontLoader = new FontLoader();
let fuenteCargada = null; 
const FONT_URL = 'https://unpkg.com/three@0.158.0/examples/fonts/helvetiker_bold.typeface.json';

const piezas = {
  base: {file:"Helm-Wandhalter.stl", mesh:null},
  superior: {file:"Helm-Halter.stl", mesh:null},
  inserts: ["Insert1.stl","Insert2.stl","Insert3.stl","Insert4.stl","Insert5.stl"],
  insertMeshes: [],
  logo: { mesh:null } // Puede ser Mesh (STL) o Group (Texto separado)
};

let grupoActivo = "base";
let modoLogo = "catalogo";
const seleccion = {
  base: {c:"#000000"}, superior: {c:"#ff8000"}, insert: {c:"#ff8000"}, logo: {c:"#ff8000"}
};

/* CARGAR MODELOS */
function cargarEstructura(){
  loader.load(piezas.base.file, g=>{
    const m=new THREE.Mesh(g,new THREE.MeshStandardMaterial({color:seleccion.base.c}));
    m.rotation.set(Math.PI,0,Math.PI); world.add(m); piezas.base.mesh=m;
  });
  loader.load(piezas.superior.file,g=>{
    const m=new THREE.Mesh(g,new THREE.MeshStandardMaterial({color:seleccion.superior.c}));
    m.rotation.set(Math.PI,0,Math.PI); world.add(m); piezas.superior.mesh=m;
  });
  piezas.inserts.forEach(f=>{
    loader.load(f,g=>{
      const m=new THREE.Mesh(g,new THREE.MeshStandardMaterial({color:seleccion.insert.c}));
      m.rotation.set(Math.PI,0,Math.PI); world.add(m); piezas.insertMeshes.push(m);
    });
  });
  
  fontLoader.load(FONT_URL, (font) => { fuenteCargada = font; });
  cargarLogoSTL("logoYamaha.stl");
}

/* L√ìGICA DE LOGOS (STL Y TEXTO) */
function limpiarLogoAnterior(){
  if(piezas.logo.mesh){
    world.remove(piezas.logo.mesh);
    // Si es un grupo (Texto separado)
    if(piezas.logo.mesh.isGroup){
      piezas.logo.mesh.children.forEach(c => {
        if(c.geometry) c.geometry.dispose();
        if(c.material) c.material.dispose();
      });
    } else {
      // Si es un mesh normal (STL)
      if(piezas.logo.mesh.geometry) piezas.logo.mesh.geometry.dispose();
      if(piezas.logo.mesh.material) piezas.logo.mesh.material.dispose();
    }
    piezas.logo.mesh = null;
  }
}

// 1. Cargar STL
function cargarLogoSTL(archivo){
  limpiarLogoAnterior();
  if(!archivo || archivo === "") return;

  loader.load(archivo, g=>{
    const m=new THREE.Mesh(g,new THREE.MeshStandardMaterial({color:seleccion.logo.c}));
    m.position.set(STL_POS.x, STL_POS.y, STL_POS.z);
    m.rotation.set(STL_ROT.x, STL_ROT.y, STL_ROT.z);
    world.add(m); piezas.logo.mesh=m;
  });
}

// 2. Generar Texto 3D (CORREGIDO PARA ESPACIOS)
function generarTexto3D(textoString){
  limpiarLogoAnterior();
  if(!fuenteCargada) return;
  
  // Convertimos a may√∫sculas para mejor consistencia (opcional)
  // textoString = textoString.toUpperCase(); 

  if(!textoString || textoString === "") return;

  // --- CONFIGURACI√ìN ---
  const espacioLetras = 2; // Separaci√≥n extra
  const sizeLetra = 18;
  const alturaLetra = 2;
  
  const grupoTexto = new THREE.Group();
  let offsetActual = 0;

  // Recorremos cada letra
  const letras = textoString.split('');
  
  // Material √∫nico compartido
  const mat = new THREE.MeshStandardMaterial({color: seleccion.logo.c});

  letras.forEach(letra => {
    
    // --- FIX: Si es un espacio, solo avanzamos el offset y saltamos ---
    if(letra === " "){
        // Avanzamos el ancho aprox de un espacio (ej: tama√±o / 2)
        offsetActual += sizeLetra / 1.5;
        return; 
    }

    // Geometr√≠a individual
    const geo = new TextGeometry(letra, {
        font: fuenteCargada, 
        size: sizeLetra, 
        height: alturaLetra, 
        curveSegments: 4,
        bevelEnabled: true, bevelThickness: 0.5, bevelSize: 0.3, bevelOffset: 0, bevelSegments: 3
    });

    geo.computeBoundingBox();
    const anchoLetra = geo.boundingBox.max.x - geo.boundingBox.min.x;
    
    // Movemos la geometr√≠a a su posici√≥n en la fila
    geo.translate(offsetActual, 0, 0);

    const meshLetra = new THREE.Mesh(geo, mat);
    grupoTexto.add(meshLetra);

    // Aumentamos el offset para la siguiente letra
    offsetActual += anchoLetra + espacioLetras;
  });

  // Centrar el GRUPO completo
  const centroX = -offsetActual / 2;
  const centroY = -sizeLetra / 2; 

  // Ajuste interno del grupo para que su pivote sea el centro
  grupoTexto.children.forEach(child => {
      child.geometry.translate(centroX, centroY, 0);
  });

  // APLICAR TUS VALORES DE CALIBRACI√ìN AL GRUPO
  grupoTexto.position.set(TXT_POS.x, TXT_POS.y, TXT_POS.z);
  grupoTexto.rotation.set(TXT_ROT.x, TXT_ROT.y, TXT_ROT.z);

  world.add(grupoTexto); 
  piezas.logo.mesh = grupoTexto;
}

/* INTERFAZ LOGO */
const radioInputs = document.querySelectorAll('input[name="tipoLogo"]');
const contSelect = document.getElementById('cont-select-logo');
const contInput = document.getElementById('cont-input-text');
const logoSelect = document.getElementById('logo-select');
const customInput = document.getElementById('custom-text');

radioInputs.forEach(radio => {
  radio.addEventListener('change', (e) => {
    modoLogo = e.target.value;
    if(modoLogo === 'catalogo'){
      contSelect.classList.remove('hidden'); contInput.classList.add('hidden');
      cargarLogoSTL(logoSelect.value);
    } else {
      contSelect.classList.add('hidden'); contInput.classList.remove('hidden');
      generarTexto3D(customInput.value);
    }
  });
});

customInput.addEventListener('input', (e)=>{ generarTexto3D(e.target.value); });

/* COLORES */
const colores=[
  {n:"Amarillo",c:"#ffff00"}, {n:"Dorado",c:"#ffcc33"}, {n:"Blanco",c:"#ffffff"},
  {n:"Negro",c:"#000000"}, {n:"Azul",c:"#0000ff"}, {n:"Verde Lim√≥n",c:"#ccff00"},
  {n:"Verde",c:"#2e7d32"}, {n:"Rosado",c:"#ff66cc"}, {n:"Morado",c:"#8000ff"},
  {n:"Caf√©",c:"#8b4513"}, {n:"Rojo",c:"#ff0000"}, {n:"Gris",c:"#808080"}, {n:"Naranja",c:"#ff8000"}
];

const paleta = document.getElementById("paleta");

function aplicarColor(grupo, hex){
  seleccion[grupo].c = hex;
  if(grupo==="base" && piezas.base.mesh) piezas.base.mesh.material.color.set(hex);
  if(grupo==="superior" && piezas.superior.mesh) piezas.superior.mesh.material.color.set(hex);
  if(grupo==="insert") piezas.insertMeshes.forEach(m=>m.material.color.set(hex));
  
  // LOGO: Ahora puede ser un Grupo (Texto) o un Mesh (STL)
  if(grupo==="logo" && piezas.logo.mesh) {
    if(piezas.logo.mesh.isGroup) {
        // Si es texto (grupo), pintamos cada letra
        piezas.logo.mesh.children.forEach(child => child.material.color.set(hex));
    } else {
        // Si es STL, pintamos normal
        piezas.logo.mesh.material.color.set(hex);
    }
  }
}

function crearPaleta(){
  colores.forEach(col=>{
    const el=document.createElement("div"); el.className="color"; el.dataset.hex=col.c; el.style.background=col.c;
    el.addEventListener("click",()=>{ aplicarColor(grupoActivo, col.c); resaltarSeleccion(); });
    paleta.appendChild(el);
  });
  resaltarSeleccion();
}

function resaltarSeleccion(){
  const hexSel=seleccion[grupoActivo].c;
  paleta.querySelectorAll(".color").forEach(el=>{
    if(el.dataset.hex===hexSel) el.classList.add("sel"); else el.classList.remove("sel");
  });
}

/* TABS */
const tabs = document.querySelectorAll(".tab");
const logoBlock = document.getElementById("logo-block");

tabs.forEach(tab=>{
  tab.addEventListener("click",()=>{
    tabs.forEach(t=>t.classList.remove("activo")); tab.classList.add("activo");
    grupoActivo=tab.dataset.grupo;
    if(grupoActivo==="logo") logoBlock.style.display="flex"; else logoBlock.style.display="none";
    resaltarSeleccion();
  });
});

/* LISTA LOGOS */
const logos=[
  {n:"Yamaha",f:"logoYamaha.stl"}, {n:"Sin logo",f:""}, {n:"Nmax",f:"logoNmax.stl"},
  {n:"V-Strom",f:"logoVstrom.stl"}, {n:"Ktm",f:"logoKtm.stl"}, {n:"FOX",f:"logoFox.stl"},
  {n:"Monster",f:"logoMonster.stl"}, {n:"Nike",f:"logoNike.stl"}, {n:"Honda",f:"logoHonda.stl"},
  {n:"Suzuki",f:"logoSuzuki.stl"}, {n:"Pulsar",f:"logoPulsar.stl"}, {n:"AKT",f:"logoAKT.stl"},
  {n:"Royal Enfield",f:"logoRoyal.stl"}, {n:"Dominar",f:"logoDominar.stl"},
  {n:"Kawasaki",f:"logoKawasaki.stl"}, {n:"Discover",f:"logoDiscover.stl"}
];
logos.forEach(l=>{
  const opt=document.createElement("option"); opt.value=l.f; opt.textContent=l.n;
  logoSelect.appendChild(opt);
});
logoSelect.addEventListener("change",()=>{ cargarLogoSTL(logoSelect.value); });

/* WHATSAPP */
function nombreColor(hex){
  const c = colores.find(x=>x.c.toLowerCase()===hex.toLowerCase()); return c ? c.n : "Personalizado";
}
document.getElementById("enviarWhatsApp").addEventListener("click",()=>{
  const baseC = nombreColor(seleccion.base.c);
  const supC  = nombreColor(seleccion.superior.c);
  const insC  = nombreColor(seleccion.insert.c);
  const logC  = nombreColor(seleccion.logo.c);
  let infoLogo = "";
  if(modoLogo === "catalogo"){
    const nombreL = logoSelect.selectedOptions[0]?.textContent || "Ninguno";
    infoLogo = `Logo cat√°logo: ${nombreL}`;
  } else {
    const texto = customInput.value || "Sin texto";
    infoLogo = `Nombre personalizado: "${texto}"`;
  }
  const msg = `Hola Kreoma3D! üëã\nQuiero mi soporte personalizado:\n‚Ä¢ Base: ${baseC}\n‚Ä¢ Superior: ${supC}\n‚Ä¢ Insertos: ${insC}\n‚Ä¢ ${infoLogo} (Color: ${logC})`;
  window.open(`https://wa.me/573332395481?text=${encodeURIComponent(msg)}`,"_blank");
});

/* LOOP */
function animate(){ requestAnimationFrame(animate); controls.update(); renderer.render(scene,camera); }
animate();
window.addEventListener("resize",()=>{
  const w = canvasContainer.clientWidth; const h = canvasContainer.clientHeight;
  renderer.setSize(w,h); camera.aspect=w/h; camera.updateProjectionMatrix();
});

cargarEstructura();
crearPaleta();
</script>
</body>

</html>


